<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cancel RSVP — Gather</title>
  <link rel="stylesheet" href="/css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>body { font-family: 'Inter', -apple-system, sans-serif; }</style>
</head>
<body>
  <nav class="navbar">
    <a href="/" class="logo"><span class="logo-dot"></span> gather</a>
  </nav>

  <div class="confirmation-page">
    <div class="container">
      <div id="loading" class="loading"><div class="spinner"></div></div>
      <div id="content" style="display:none;"></div>
    </div>
  </div>

  <script>
    const parts = window.location.pathname.split('/');
    const attendeeId = parts[2];
    const token = parts[3];

    async function load() {
      // First get attendee info
      try {
        const res = await fetch(`/api/attendees/${attendeeId}`);
        if (!res.ok) throw new Error('Not found');
        const data = await res.json();

        document.getElementById('content').innerHTML = `
          <div style="max-width: 400px; margin: 0 auto;">
            <h1 style="font-size: 1.75rem;">Cancel your RSVP?</h1>
            <p class="text-muted mt-2">You're about to cancel your registration for:</p>

            <div class="card mt-6" style="text-align: left;">
              <h3>${data.event.title}</h3>
              <p class="text-sm text-muted mt-2">${data.event.date} · ${data.event.location}</p>
              <p class="text-sm mt-2"><strong>${data.name}</strong> · ${data.email}</p>
            </div>

            <div class="mt-6" style="display: flex; gap: 12px;">
              <button class="btn btn-primary btn-lg" style="flex:1; background: var(--red);" id="confirm-btn">Yes, Cancel My RSVP</button>
            </div>
            <a href="/" class="btn btn-ghost btn-sm mt-4">Never mind, go back</a>

            <div id="error-msg" class="mt-4 text-sm" style="color: var(--red); display: none;"></div>
          </div>
        `;

        document.getElementById('confirm-btn').addEventListener('click', async () => {
          const btn = document.getElementById('confirm-btn');
          btn.disabled = true;
          btn.textContent = 'Cancelling...';

          try {
            const cancelRes = await fetch(`/api/attendees/${attendeeId}/cancel`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ cancel_token: token }),
            });

            if (!cancelRes.ok) {
              const err = await cancelRes.json();
              throw new Error(err.error || 'Failed to cancel');
            }

            document.getElementById('content').innerHTML = `
              <div class="success-icon" style="background: var(--red-bg);">
                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="var(--red)" stroke-width="2.5">
                  <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
              </div>
              <h1 style="font-size: 1.75rem;">RSVP Cancelled</h1>
              <p class="text-muted mt-2">Your registration has been cancelled. Your spot has been freed up for someone else.</p>
              <a href="/" class="btn btn-outline mt-6">Go Home</a>
            `;
          } catch (err) {
            const errEl = document.getElementById('error-msg');
            errEl.textContent = err.message;
            errEl.style.display = 'block';
            btn.disabled = false;
            btn.textContent = 'Yes, Cancel My RSVP';
          }
        });

        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
      } catch {
        document.getElementById('loading').innerHTML = '<p class="text-center text-muted">Registration not found</p>';
      }
    }

    load();
  </script>
</body>
</html>
