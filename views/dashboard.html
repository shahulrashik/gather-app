<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard â€” Gather</title>
  <link rel="stylesheet" href="/css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>body { font-family: 'Inter', -apple-system, sans-serif; }</style>
</head>
<body>
  <nav class="navbar">
    <a href="/" class="logo">
      <span class="logo-dot"></span>
      gather
    </a>
    <div class="nav-actions" id="nav-actions"></div>
  </nav>

  <div class="dashboard-page">
    <div class="container-wide">
      <div id="loading" class="loading"><div class="spinner"></div></div>
      <div id="dashboard-content" style="display:none;"></div>
    </div>
  </div>

  <script>
    const slug = window.location.pathname.split('/')[2];

    function getInitials(name) {
      return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
    }

    function formatDate(dateStr) {
      const d = new Date(dateStr);
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      return `${months[d.getMonth()]} ${d.getDate()}`;
    }

    async function loadDashboard() {
      try {
        const res = await fetch(`/api/events/${slug}/attendees`);
        if (!res.ok) throw new Error('Failed to load');
        const data = await res.json();
        const { event, attendees, total, checked_in } = data;

        document.title = `Dashboard â€” ${event.title}`;

        document.getElementById('nav-actions').innerHTML = `
          <a href="/event/${slug}" class="btn btn-ghost btn-sm">View Event</a>
          <a href="/event/${slug}/checkin" class="btn btn-primary btn-sm">QR Check-in</a>
        `;

        const spotsLeft = Math.max(0, event.capacity - total);

        document.getElementById('dashboard-content').innerHTML = `
          <div class="dashboard-header">
            <div>
              <h1>${event.title}</h1>
              <p class="text-muted text-sm">${event.location}</p>
            </div>
          </div>

          <div class="stats-grid">
            <div class="card stat-card">
              <div class="stat-value">${total}</div>
              <div class="stat-label">Total RSVPs</div>
            </div>
            <div class="card stat-card">
              <div class="stat-value">${checked_in}</div>
              <div class="stat-label">Checked In</div>
            </div>
            <div class="card stat-card">
              <div class="stat-value">${spotsLeft}</div>
              <div class="stat-label">Spots Left</div>
            </div>
          </div>

          <div class="card">
            <div class="search-bar">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
              </svg>
              <input type="text" id="search-input" placeholder="Search by name or email...">
            </div>

            <div id="attendee-list" class="attendee-list">
              ${attendees.length === 0
                ? `<div class="empty-state">
                    <div class="empty-state-icon">ðŸ‘¥</div>
                    <h3>No attendees yet</h3>
                    <p>Share your event link to get RSVPs</p>
                  </div>`
                : attendees.map(a => `
                  <div class="attendee-row" data-name="${a.name.toLowerCase()}" data-email="${a.email.toLowerCase()}" data-id="${a.id}">
                    <div class="attendee-avatar">${getInitials(a.name)}</div>
                    <div class="attendee-info">
                      <div class="attendee-name">${a.name}</div>
                      <div class="attendee-email">${a.email}</div>
                    </div>
                    <div class="attendee-actions">
                      <span class="badge ${a.checked_in ? 'badge-checked' : 'badge-pending'}" id="badge-${a.id}">
                        ${a.checked_in ? 'âœ“ Checked in' : 'Not checked in'}
                      </span>
                      ${!a.checked_in ? `
                        <button class="btn btn-sm btn-outline checkin-btn" data-id="${a.id}" id="btn-${a.id}">
                          Check in
                        </button>
                      ` : ''}
                    </div>
                  </div>
                `).join('')}
            </div>
          </div>
        `;

        // Search
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
          searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            document.querySelectorAll('.attendee-row').forEach(row => {
              const name = row.dataset.name;
              const email = row.dataset.email;
              row.style.display = (name.includes(query) || email.includes(query)) ? '' : 'none';
            });
          });
        }

        // Check-in buttons
        document.querySelectorAll('.checkin-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const id = btn.dataset.id;
            btn.disabled = true;
            btn.textContent = '...';

            try {
              const res = await fetch(`/api/attendees/${id}/checkin`, { method: 'POST' });
              if (res.ok) {
                const badge = document.getElementById(`badge-${id}`);
                badge.className = 'badge badge-checked';
                badge.textContent = 'âœ“ Checked in';
                btn.remove();

                // Update stat
                loadDashboard();
              }
            } catch (err) {
              btn.disabled = false;
              btn.textContent = 'Check in';
            }
          });
        });

        document.getElementById('loading').style.display = 'none';
        document.getElementById('dashboard-content').style.display = 'block';

      } catch (err) {
        document.getElementById('loading').innerHTML = '<p class="text-center text-muted">Failed to load dashboard</p>';
      }
    }

    loadDashboard();
  </script>
</body>
</html>
